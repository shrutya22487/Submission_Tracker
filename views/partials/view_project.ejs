<!-- Working console section -->
<div class="col-md-6"
     style="background-color: #f9f9f9; width: 100%; height: 100%; margin-left: auto; margin-right: auto; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
    <div id="working-console">
        <div class="jumbotron text-center" style="margin-bottom: 20px;">
            <h1 style="font-size: 4rem; font-weight: bold; color: #333;">Professor Dashboard</h1>
        </div>

        <!-- Combined section for adding a project and research projects -->
        <div>
            <!-- FOR ADDING A PROJECT-->
            <form id="addProjectForm" style="background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); margin-bottom: 40px;" onsubmit="return add_project();">
                <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">Add New Project</h2>

                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" required class="form-control" style="margin-bottom: 10px;">
                </div>

                <div class="form-group">
                    <label for="conference">Conference</label>
                    <input type="text" id="conference" name="conference" class="form-control" style="margin-bottom: 10px;">
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status" required class="form-control" style="margin-bottom: 10px;">
                        <option value="Upcoming">Upcoming</option>
                        <option value="Under Review">Under Review</option>
                        <option value="In Progress">In Progress</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="link_1">Link 1</label>
                    <input type="url" id="link_1" name="link_1" class="form-control" style="margin-bottom: 10px;">
                </div>

                <div class="form-group">
                    <label for="link_2">Link 2</label>
                    <input type="url" id="link_2" name="link_2" class="form-control" style="margin-bottom: 10px;">
                </div>

                <div class="form-group">
                    <label for="submitted_date">Submitted Date</label>
                    <input type="date" id="submitted_date" name="submitted_date" class="form-control" style="margin-bottom: 10px;">
                </div>

                <div class="form-group">
                    <label for="deadline_date">Deadline Date</label>
                    <input type="date" id="deadline_date" name="deadline_date" class="form-control" style="margin-bottom: 20px;">
                </div>

                <button type="submit" class="btn btn-primary btn-block" style="font-size: 1.2rem;">Add Project</button>
            </form>
            <!-- FOR EDITING A PROJECT -->
            <div id="edit-project-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span class="close-button" onclick="closeEditModal()">&times;</span>
                    <h2>Edit Project</h2>
                    <form id="edit-project-form">
                        <input type="hidden" id="search-project_id" name="project_id">
                        <div>
                            <label for="title">Project Title:</label>
                            <input type="text" id="search-title" name="title" value="">
                        </div>
                        <div>
                            <label for="conference">Conference:</label>
                            <input type="text" id="search-conference" name="conference">
                        </div>
                        <div>
                            <label for="status">Status:</label>
                            <input type="text" id="search-status" name="status">
                        </div>
                        <div>
                            <label for="link_1">Link 1:</label>
                            <input type="url" id="search-link_1" name="link_1">
                        </div>
                        <div>
                            <label for="link_2">Link 2:</label>
                            <input type="url" id="search-link_2" name="link_2">
                        </div>
                        <div>
                            <label for="submitted_date">Submitted Date:</label>
                            <input type="date" id="search-submitted_date" name="submitted_date">
                        </div>
                        <div>
                            <label for="deadline_date">Deadline Date:</label>
                            <input type="date" id="search-deadline_date" name="deadline_date">
                        </div>
                        <button type="submit" onclick="edit_project()">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- FOR UNARCHIVED PROJECTS-->
            <div class="container mt-5">
                <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 20px;">Research Projects</h2>

                <% if (project_details_unarchived && Array.isArray(project_details_unarchived.rows) && project_details_unarchived.rows.length > 0) { %>
                    <ul style="font-size: 1.2rem;">
                        <% project_details_unarchived.rows.forEach(function(detail) { %>

                            <li class="project-list-item" style="padding: 10px 0; border-bottom: 1px solid #ddd;">
                                <strong>Project:</strong> <%= detail.project_title %>
                                (Conference: <%= detail.project_conference %>, Status: <%= detail.status %>)
                                <br>
                                <a href="<%= detail.link_1 %>">Link 1</a> | <a href="<%= detail.link_2 %>">Link 2</a>
                                <br>
                                Submitted: <%= detail.submitted_data ? detail.submitted_data.toDateString() : 'N/A' %>
                                | Deadline: <%= detail.deadline_data ? detail.deadline_data.toDateString() : 'N/A' %>

                                <!-- Flex container to align buttons horizontally -->
                                <div class="d-flex justify-content-start align-items-center mt-2">
                                    <button class="btn btn-sm btn-warning archive_project_button mr-2" onclick="archive_project(<%= detail.project_id %>)">Archive</button>
                                    <button class="btn btn-sm btn-danger delete_project_button mr-2" onclick="delete_project(<%= detail.project_id %>)">Delete</button>
                                    <button class="btn btn-sm btn-info mr-2" onclick="toggleSearchBar(<%= detail.project_id %>)">Add Student</button>
                                    <button class="btn btn-sm btn-secondary" onclick="openEditModal(<%= detail.project_id %>)">Edit Project</button>
                                </div>
                                <!-- Hidden Search Bar Container -->
                                <div id="search-bar-<%= detail.project_id %>" class="search-bar-container" style="display: none; margin-top: 20px;">
                                    <h3 style="font-size: 1.5rem; margin-bottom: 20px;">Student Search</h3>

                                    <!-- Search Form -->
                                    <form id="search-form" class="d-flex justify-content-center align-items-center" style="margin-bottom: 20px;">
                                        <input type="text" id="student-search-project-<%= detail.project_id %>"
                                               data-project-id="<%= detail.project_id %>"
                                               placeholder="Type student name..."
                                               oninput="searchStudents(<%= detail.project_id %>)"
                                               class="form-control"
                                               style="max-width: 600px; padding: 10px 20px; border-radius: 50px; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"
                                               autocomplete="off" required>
                                    </form>

                                    <!-- Search Results Box -->
                                    <div id="student-results-<%= detail.project_id %>" class="results-box" style="display: none;">
                                        <!-- Search results will be displayed here -->
                                    </div>
                                </div>

                                <!-- Student List -->
                                <ul class="student-list" style="margin-top: 10px;">
                                    <li><strong>Students:</strong> <%= detail.students ? detail.students : 'No students assigned' %></li>
                                </ul>

                                <!-- Meeting Notes List -->
                                <ul class="meeting-notes-list" style="margin-top: 10px;">
                                    <li><strong>Meeting Notes:</strong></li>
                                    <% if (detail.meeting_notes) { %>
                                        <% detail.meeting_notes.split('; ').forEach(function(note) { %>
                                            <% const noteText = note.replace(/\s\[\d+\]$/, ''); %>
                                            <% const noteIdMatch = note.match(/\[(\d+)\]$/); %>
                                            <% const noteId = noteIdMatch ? noteIdMatch[1] : null; %>
                                            <li data-note-id="<%= noteId %>">
                                                <%= noteText %>
                                                <% if (noteId) { %>
                                                    <button onclick="deleteMeetingNotes(<%= noteId %>)" style="background: none; border: none;">
                                                        🗑️
                                                    </button>
                                                <% } %>
                                            </li>
                                        <% }) %>
                                    <% } else { %>
                                        <li>No meeting notes available.</li>
                                    <% } %>
                                </ul>


                                <!-- Add Meeting Notes Form -->
                                <form class="add-notes-form" style="margin-top: 10px;">
                                    <input type="hidden" name="project_id" value="<%= detail.project_id %>">
                                    <div class="form-group">
                                        <label for="meeting-notes-input-<%= detail.project_id %>">Add Meeting Notes:</label>
                                        <textarea class="form-control" id="meeting-notes-input-<%= detail.project_id %>" name="notes" placeholder="Enter meeting notes..." required></textarea>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="addMeetingNotes(<%= detail.project_id %>)">Add Notes</button>
                                </form>

                            </li>
                        <% }); %>
                    </ul>
                <% } else { %>
                    <p>No projects found.</p>
                <% } %>
            </div>
        </div>

        <!-- FOR ARCHIVED PROJECTS-->
        <div class="container mt-5">
            <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 20px;">Research Projects</h2>

            <% if (project_details_archived && Array.isArray(project_details_archived.rows) && project_details_archived.rows.length > 0) { %>
                <ul style="font-size: 1.2rem;">
                    <% project_details_archived.rows.forEach(function(detail) { %>

                        <li class="project-list-item" style="padding: 10px 0; border-bottom: 1px solid #ddd;">
                            <strong>Project:</strong> <%= detail.project_title %>
                            (Conference: <%= detail.project_conference %>, Status: <%= detail.status %>)
                            <br>
                            <a href="<%= detail.link_1 %>">Link 1</a> | <a href="<%= detail.link_2 %>">Link 2</a>
                            <br>
                            Submitted: <%= detail.submitted_data ? detail.submitted_data.toDateString() : 'N/A' %>
                            | Deadline: <%= detail.deadline_data ? detail.deadline_data.toDateString() : 'N/A' %>

                            <!-- Flex container to align buttons horizontally -->
                            <div class="d-flex justify-content-start align-items-center mt-2">
                                <button class="btn btn-sm btn-warning archive_project_button mr-2" onclick="archive_project(<%= detail.project_id %>)">Archive</button>
                                <button class="btn btn-sm btn-danger delete_project_button mr-2" onclick="delete_project(<%= detail.project_id %>)">Delete</button>
                                <button class="btn btn-sm btn-info mr-2" onclick="toggleSearchBar(<%= detail.project_id %>)">Add Student</button>
                                <button class="btn btn-sm btn-secondary" onclick="openEditModal(<%= detail.project_id %>)">Edit Project</button>
                            </div>

                            <!-- Hidden Search Bar Container -->
                            <div id="search-bar-<%= detail.project_id %>" class="search-bar-container" style="display: none; margin-top: 20px;">
                                <h3 style="font-size: 1.5rem; margin-bottom: 20px;">Student Search</h3>

                                <!-- Search Form -->
                                <form id="search-form" class="d-flex justify-content-center align-items-center" style="margin-bottom: 20px;">
                                    <input type="text" id="student-search-project-<%= detail.project_id %>"
                                           data-project-id="<%= detail.project_id %>"
                                           placeholder="Type student name..."
                                           oninput="searchStudents(<%= detail.project_id %>)"
                                           class="form-control"
                                           style="max-width: 600px; padding: 10px 20px; border-radius: 50px; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"
                                           autocomplete="off" required>
                                </form>

                                <!-- Search Results Box -->
                                <div id="student-results-<%= detail.project_id %>" class="results-box" style="display: none;">
                                    <!-- Search results will be displayed here -->
                                </div>
                            </div>

                            <!-- Student List -->
                            <ul class="student-list" style="margin-top: 10px;">
                                <li><strong>Students:</strong>
                                    <% if (detail.students) { %>
                                        <% detail.students.split(', ').forEach((student) => { %>
                                            <% const [name, email] = student.match(/(.*) \((.*)\)/).slice(1); %>
                                            <span class="student-item">
                                <span class="student-name"
                                      onmouseover="showOptions('<%= email %>')"
                                      onmouseout="hideOptions()">
                                      <%= name %>
                                </span>
                                <span class="student-options" style="display: none;" id="<%= email %>-options">
                                    <button onclick="copyToClipboard('<%= email %>')">Copy Email</button>
                                    <button onclick="deleteStudent('<%= email %>', <%= detail.project_id %>)">Delete</button>
                                </span>
                                </span>
                                        <% }); %>
                                    <% } else { %>
                                        No students assigned
                                    <% } %>
                                </li>
                            </ul>



                            <!-- Meeting Notes List -->
                            <ul class="meeting-notes-list" style="margin-top: 10px;">
                                <li><strong>Meeting Notes:</strong></li>
                                <% if (detail.meeting_notes) { %>
                                    <% detail.meeting_notes.split('; ').forEach(function(note) { %>
                                        <% const noteText = note.replace(/\s\[\d+\]$/, ''); %>
                                        <% const noteIdMatch = note.match(/\[(\d+)\]$/); %>
                                        <% const noteId = noteIdMatch ? noteIdMatch[1] : null; %>
                                        <li data-note-id="<%= noteId %>">
                                            <%= noteText %>
                                            <% if (noteId) { %>
                                                <button onclick="deleteMeetingNotes(<%= noteId %>)" style="background: none; border: none;">
                                                    🗑️
                                                </button>
                                            <% } %>
                                        </li>
                                    <% }) %>
                                <% } else { %>
                                    <li>No meeting notes available.</li>
                                <% } %>
                            </ul>


                            <!-- Add Meeting Notes Form -->
                            <form class="add-notes-form" style="margin-top: 10px;">
                                <input type="hidden" name="project_id" value="<%= detail.project_id %>">
                                <div class="form-group">
                                    <label for="meeting-notes-input-<%= detail.project_id %>">Add Meeting Notes:</label>
                                    <textarea class="form-control" id="meeting-notes-input-<%= detail.project_id %>" name="notes" placeholder="Enter meeting notes..." required></textarea>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addMeetingNotes(<%= detail.project_id %>)">Add Notes</button>
                            </form>

                        </li>
                    <% }); %>
                </ul>
            <% } else { %>
                <p>No projects found.</p>
            <% } %>
        </div>
    </div>
</div>
<script>
    function showOptions(email) {
        document.getElementById(email + "-options").style.display = "inline";
    }

    function hideOptions() {
        document.querySelectorAll(".student-options").forEach(el => el.style.display = "none");
    }

    function copyToClipboard(email) {
        navigator.clipboard.writeText(email)
            .then(() => alert(`Email ${email} copied to clipboard!`))
            .catch(err => console.error("Failed to copy text: ", err));
    }

    function deleteStudent(email, projectId) {
        if (confirm("Are you sure you want to delete this student from the project?")) {
            fetch(`/project/${projectId}/remove-student`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ email: email })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Student removed successfully");
                        location.reload();
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .catch(err => console.error("Failed to remove student:", err));
        }
    }
</script>
